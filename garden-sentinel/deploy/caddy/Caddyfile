# Garden Sentinel Caddy configuration
# Automatic HTTPS with Let's Encrypt

{
    # Global options
    email admin@example.com

    # Uncomment for staging certificates during testing
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory

    # For local development without real domain
    auto_https off
}

# Main site - use localhost for development
:80 {
    # Logging
    log {
        output stdout
        format console
    }

    # Security headers
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }

    # Health check (no auth required)
    handle /health {
        reverse_proxy server:5000
    }

    # API documentation
    handle /docs* {
        reverse_proxy server:5000
    }

    handle /openapi.json {
        reverse_proxy server:5000
    }

    # API endpoints
    handle /api/* {
        reverse_proxy server:5000 {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # WebSocket connections
    @websocket {
        header Connection *Upgrade*
        header Upgrade websocket
    }
    handle @websocket {
        reverse_proxy server:5000
    }

    handle /ws {
        reverse_proxy server:5000
    }

    # Video streams (disable buffering)
    handle /stream/* {
        reverse_proxy server:5000 {
            flush_interval -1
        }
    }

    # Metrics endpoint
    handle /metrics {
        reverse_proxy server:5000
    }

    # Grafana
    handle /grafana/* {
        uri strip_prefix /grafana
        reverse_proxy grafana:3000
    }

    # Static dashboard files
    handle {
        root * /var/www/garden-sentinel/dashboard
        try_files {path} /index.html
        file_server

        # Cache static assets
        @static {
            path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2
        }
        header @static Cache-Control "public, max-age=31536000, immutable"
    }
}
